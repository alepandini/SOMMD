---
title: "Demo"
author: "Hamid Davoudkhani , Shaziya Ismail Mulla" 
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
  pdf_document: default
editor_options:
  chunk_output_type: console
---
```{r include=FALSE}
knitr::opts_chunk$set(comment = '>')

library(usethis)
library(devtools)
library(fs)
library(tidyverse)
library(bio3d)

load_all()
library(SOMMD)
library(kohonen)
library(crayon)

```


Reading the files   PDB and Trajectories  **REQ-1** and **REQ-2**
```{r}
## Reading the files   PDB and Trajectories  **REQ-1** **REQ-2**


pdb <- read_pdb("~/Documents/Dissertation/provided files/Medium_Dataset/Medium_Dataset/ref.pdb")
trj1 <- read_ncdf("~/Documents/Dissertation/provided files/Medium_Dataset/Medium_Dataset/TEST_001.nc")
trj2 <- read_ncdf("~/Documents/Dissertation/provided files/Medium_Dataset/Medium_Dataset/REP_002.nc")
trj3 <- read_ncdf("~/Documents/Dissertation/provided files/Medium_Dataset/Medium_Dataset/REP_003.nc")
trj4 <- read_ncdf("~/Documents/Dissertation/provided files/Medium_Dataset/Medium_Dataset/REP_004.nc")
trj5 <- read_ncdf("~/Documents/Dissertation/provided files/Medium_Dataset/Medium_Dataset/REP_005.nc")
trj6 <- read_ncdf("~/Documents/Dissertation/provided files/Medium_Dataset/Medium_Dataset/REP_006.nc")
trj7 <- read_ncdf("~/Documents/Dissertation/provided files/Medium_Dataset/Medium_Dataset/REP_007.nc")
trj8 <- read_ncdf("~/Documents/Dissertation/provided files/Medium_Dataset/Medium_Dataset/REP_008.nc")
trj9 <- read_ncdf("~/Documents/Dissertation/provided files/Medium_Dataset/Medium_Dataset/REP_009.nc")
trj10 <- read_ncdf("~/Documents/Dissertation/provided files/Medium_Dataset/Medium_Dataset/REP_010.nc")

trj<- rbind(trj1 , trj2 ,trj3, trj4 ,trj5, trj6 ,trj7 ,trj8 ,trj9 ,trj10)
trjs2 <- rbind(trj1 , trj2 ,trj3, trj4 ,trj5 )

```


❯ mdconvert -o REP_010.nc  REP_010.xtc


Concatinating the pdb and trj files  **REQ-2**
```{r}

merged_pdb <- Merge_pdb_trj(pdb1 , trj)
merged_pdb2 <- Merge_pdb_trj(pdb1 , trjs2)

```



filter the pdb and choose C\beta   **REQ-2**
```{r}

filtered_pdb <- filter_atoms(merged_pdb, atom = "CB")
filtered_pdb2 <- filter_atoms(merged_pdb2, atom = "CB")
```


pre-alignment the frames **REQ-3**
```{r}

gaps <- gap.inspect(filtered_pdb$xyz)

prealign_pdb <- fit_dist_frame(filtered_pdb$xyz[1,], 
                               filtered_pdb$xyz,
                               fixed.inds = gaps$f.inds,
                               mobile.inds = gaps$f.inds)

```


distance matrix **REQ-4** 

```{r}

dm_pdb <- rdm(filtered_pdb2)

```



train the SOM **REQ-5** 

```{r}
## using pre alignment object to train
som_pre_trj <- som(prealign_pdb , grid = somgrid( 8 , 8 , "hexagonal")) 

## using pre distance  object to train
som_dm_trj <- som(as.matrix(dm_pdb), grid = somgrid( 8 , 8 , "hexagonal" ))



```



find the optimal number of clusters  **REQ-6**
```{r}
cluster_neuron(som_pre_trj , max_cluster = 9)

cluster_neuron(som_dm_trj , max_cluster = 9)


```



after checking the result the 6 clusters is the optimal number

plot cluster with boundries **REQ-8**
```{r}
set.seed(100)

# prealignment
plot_clustered_map(som_pre_trj, cluster_method = "kmeans" , clustering_parameter = c( 6 , "Hartigan-Wong") , shape = "straight")
# distance matrix
plot_clustered_map(som_dm_trj, cluster_method = "kmeans" , clustering_parameter = c( 6 , "Hartigan-Wong") , shape = "straight")



```

draw a arbitrary path  **REQ-9**
```{r}
arbitrary_path <- c( 9 , 56 , 44 , 33 , 22)
# prealignment
plot_clustered_map(som_pre_trj, cluster_method = "kmeans" , clustering_parameter = c( 6 , "Hartigan-Wong") , shape = "straight")
add_evolution_trace(som_pre_trj , arbitrary_path)

# distance matrix
plot_clustered_map(som_dm_trj, cluster_method = "kmeans" , clustering_parameter = c( 6 , "Hartigan-Wong") , shape = "straight")
add_evolution_trace(som_dm_trj , arbitrary_path)

```

add population of each neuron on the map with shape

```{r}

# prealignment
plot_clustered_map(som_pre_trj, cluster_method = "kmeans" , clustering_parameter = c( 6 , "Hartigan-Wong") , shape = "straight")
add_neuron_population(som_pre_trj , shape = "round")

# distance matrix
plot_clustered_map(som_dm_trj, cluster_method = "kmeans" , clustering_parameter = c( 6 , "Hartigan-Wong") , shape = "straight")
add_neuron_population(som_dm_trj , shape = "round")

```



add population of each neuron on the map with digit

```{r}

# prealignment
plot_clustered_map(som_pre_trj, cluster_method = "kmeans" , clustering_parameter = c( 6 , "Hartigan-Wong") , shape = "straight")

add_neuron_population(som_pre_trj ,text = TRUE ,shape = "round")

# distance matrix
plot_clustered_map(som_dm_trj, cluster_method = "kmeans" , clustering_parameter = c( 6 , "Hartigan-Wong") , shape = "straight")
add_neuron_population(som_dm_trj ,text = TRUE ,shape = "round")

```

plot an external property of trajectories 


```{r}
## we have not that external trajectories, it is generated randomly
set.seed(100)

som_pre_k <- kmeans(som_pre_trj$codes[[1]] , 6)

dummy_property_nuerons <-  rnorm(64 , mean = 8 , sd  = 4)


# prealignment
 plot_property(som_pre_trj , property = dummy_property_nuerons ,shape = "straight",
               palette_name =  colorRampPalette(c("blue", "white", "red")))
 highlight_a_cluster(som_pre_trj,
                     som_pre_k$cluster,
                     cluster_number = 3,
                     label = "cluster 3" ,
                     # property_value = "66",
                     property_color = NULL,
                     label_color = "darkgreen",
                     col = "green",
                     lwd = 2,
                     cex = 2)

 
 # distance matrix
 
  highlight_a_cluster(som_pre_trj,
                     som_pre_k$cluster,
                     cluster_number = 5,
                     #label = "cluster 2" ,
                     #property_value = "66",
                     property_color = NULL,
                     #label_color = "darkgreen",
                     col = "green",
                     #lwd = 2,
                     #cex = 1.2
                     )

  
  
  plot_property(som_pre_trj , property = dummy_property_nuerons ,shape = "straight",
               palette_name =  colorRampPalette(c("blue", "white", "red")))
 highlight_a_cluster(som_pre_trj,
                     som_pre_k$cluster,
                     cluster_number = 3,
                     label = "important cluster" ,
                     # property_value = "66",
                     property_color = NULL,
                     label_color = "darkgreen",
                     col = "orange",
                     lwd = 5,
                     cex = 2)

 
  highlight_a_cluster(som_pre_trj,
                     som_pre_k$cluster,
                     cluster_number = 5,
                     #label = "cluster 2" ,
                     property_value = "66",
                     property_color = NULL,
                     label_color = "darkgreen",
                     col = "yellow",
                     lwd = 5,
                     cex = 1.2)

```









